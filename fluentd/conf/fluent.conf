<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  @type tail
  path /var/log/host/application.log
  pos_file /tmp/fluentd-buffers/application.log.pos
  tag spring.boot.logs
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+[+-]\d{2}:\d{2})\s+(?<level>\w+)\s+---\s+\[(?<thread>[^\]]+)\]\s+(?<logger>.+?)\s*:\s+(?<message>.*)$/
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
    keep_time_key true
  </parse>
  refresh_interval 1
</source>

# nginx 액세스 로그 파싱 (경로 수정)
<source>
  @type tail
  path /var/log/nginx/access.log
  pos_file /tmp/fluentd-buffers/nginx-access.log.pos
  tag nginx.access
  read_from_head true
  <parse>
    @type nginx
    time_format %d/%b/%Y:%H:%M:%S %z
    keep_time_key true
  </parse>
  refresh_interval 1
</source>

# nginx 에러 로그 파싱 (경로 수정)
<source>
  @type tail
  path /var/log/nginx/error.log
  pos_file /tmp/fluentd-buffers/nginx-error.log.pos
  tag nginx.error
  read_from_head true
  <parse>
    @type regexp
    expression /^(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<pid>\d+)#(?<tid>\d+): (?<message>.*)$/
    time_key timestamp
    time_format %Y/%m/%d %H:%M:%S
    keep_time_key true
  </parse>
  refresh_interval 1
</source>

<filter spring.boot.logs>
  @type record_transformer
  <record>
    application "movie-archive"
    environment "development"
    log_type "spring-boot"
    source_host "#{Socket.gethostname}"
  </record>
</filter>

# nginx 액세스 로그 필터
<filter nginx.access>
  @type record_transformer
  <record>
    application "movie-archive"
    environment "development"
    log_type "nginx-access"
    source_host "#{Socket.gethostname}"
  </record>
</filter>

# nginx 에러 로그 필터
<filter nginx.error>
  @type record_transformer
  <record>
    application "movie-archive"
    environment "development"
    log_type "nginx-error"
    source_host "#{Socket.gethostname}"
  </record>
</filter>

<match spring.boot.logs>
  @type elasticsearch
  host elasticsearch
  port 9200
  logstash_format true
  logstash_prefix spring-boot
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  time_key @timestamp
  include_type_name false
  type_name _doc
  <buffer>
    @type file
    path /tmp/fluentd-buffers/elasticsearch
    flush_mode interval
    flush_interval 5s
    chunk_limit_size 2M
    flush_thread_count 1
    retry_max_interval 30
    retry_forever false
    retry_max_times 3
  </buffer>
</match>

# nginx 로그들을 Elasticsearch로 전송
<match nginx.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  logstash_format true
  logstash_prefix nginx
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  time_key @timestamp
  include_type_name false
  type_name _doc
  <buffer>
    @type file
    path /tmp/fluentd-buffers/nginx-elasticsearch
    flush_mode interval
    flush_interval 5s
    chunk_limit_size 2M
    flush_thread_count 1
    retry_max_interval 30
    retry_forever false
    retry_max_times 3
  </buffer>
</match>

<match **>
  @type stdout
</match>